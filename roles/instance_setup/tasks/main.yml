---
- name: Generate an RSA key pair
  ansible.builtin.openssl_privatekey:
    path: "{{ key_file }}"
    type: RSA
    size: 2048
    mode: 0600
  register: private_key_result
  changed_when: private_key_result is changed

- name: Generate the public key from the private key
  ansible.builtin.shell:
    cmd: ssh-keygen -y -f "{{ key_file }}"
  register: ssh_key_gen_output

- name: Import the public key to AWS
  amazon.aws.ec2_key:
    name: "{{ key_name }}"
    key_material: "{{ lookup('file', key_file + '.pub') }}"
    region: "{{ region }}"
  register: ec2_key_result

- name: Create launch template for Spot Instance
  community.aws.ec2_launch_template:
    name: "{{ launch_template_name }}"
    image_id: ami-06e46074ae430fba6
    instance_type: t2.micro
    key_name: "{{ key_name }}"
    region: "{{ region }}"
    aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
    aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
  register: launch_template

- name: Request Spot instance
  amazon.aws.ec2_spot_instance:
    state: present
    region: "{{ region }}"
    instance_type: "{{ instance_type }}"
    image_id: "{{ image_id }}"
    key_name: "{{ key_name }}"
    spot_price: "{{ spot_price }}"
    spot_wait_timeout: "{{ spot_wait_timeout }}"
    vpc_subnet_id: "{{ vpc_subnet_id }}"
    security_group_ids:
      - "{{ security_group_id }}"
    instance_tags:
      Name: "{{ instance_name }}"
  register: spot_instance


- name: Get instance ID from Spot instance request
  set_fact:
    instance_id: "{{ spot_request.instances[0].instance_id }}"

- name: Tag Spot instance
  amazon.aws.ec2_instance:
    instance_ids: "{{ instance_id }}"
    tags:
      Name: GPT4All Instance
    region: "us-east-1"
    aws_access_key: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
    aws_secret_key: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"



- name: Allocate a new Elastic IP
  amazon.aws.ec2_eip:
    region: "us-east-1"
    AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
    AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
  register: eip

- name: Associate the new Elastic IP with the instance
  amazon.aws.ec2_eip:
    region: "us-east-1"
    AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
    AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
    instance_id: "{{ spot_request.instance_id }}"
    ip: "{{ eip.public_ip }}"

